<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>クレセントアイルCE管理</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+2:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  padding:20px;
  font-family:'M PLUS 2',sans-serif;
  background:#1a2238;
  color:#fff;
}

.container{max-width:1050px;margin:auto;}
h2{margin-bottom:12px; text-align:center;}

.columns{
  display:flex;
  gap:16px;
  align-items:flex-start;
}

/* ===== 60分枠 ===== */
.task60-column{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.task60{
  background:#2a5f78;
  border-radius:6px;
  padding:6px;
  width:100px;
  color:#fff;
}

.task60 .label60{
  font-size:12px;
  font-weight:700;
  text-align:center;
  margin-bottom:4px;
}

.task60 input[type="time"]{
  width:95%;
  font-size:12px;
  padding:2px;
  margin-bottom:4px;
  background:#0f2028;
  color:#fff;
  border:1px solid #355e6f;
}

.task60 .buttons{
  display:flex;
  gap:4px;
  margin-bottom:4px;
}

.task60 button{
  flex:1;
  font-size:11px;
  padding:2px 0;
}

/* ETA表示 */
.task60 .eta{
  font-size:16px;
  text-align:left;
  opacity:1;
  font-weight:bold;
}

/* ★ 60分枠ハイライト */
.task60.highlight{
  background:#c63c3c !important;
  color:#fff !important;
}

/* ===== 90分枠 ===== */
.column90{flex:1;}

.row{
  display:flex;
  align-items:center;
  margin-bottom:8px;
  padding:6px 8px;
  border-radius:4px;
}

.row-yellow{background:#f4e38a;color:#000;}
.row-orange{background:#f5c493;color:#000;}
.row-purple{background:#cbb4e7;color:#000;}
.row-green{background:#a9ddb4;color:#000;}
.row-blue{background:#a2c8e5;color:#000;}
.row-cyan{background:#a1e0e7;color:#000;}

.label{
  width:340px;
  font-weight:bold;
}

input[type="time"]{
  background:#1e1e2e;
  color:#fff;
  border:1px solid #444;
  padding:2px 4px;
  width:72px;
  margin-right:6px;
}

input.note{
  background:#1e1e2e;
  color:#ccc;
  border:1px solid #444;
  padding:4px;
  width:180px;
}

button{
  background:#3a4b6e;
  color:#fff;
  border:1px solid #5a6b8e;
  cursor:pointer;
  margin-right:6px;
}

button:hover{background:#4b5c80;}

.checkbox-label{
  margin-left:8px;
  font-size:13px;
  white-space:nowrap;
}

/* ETA表示 */
.eta{
  margin-left:8px;
  font-size:15px;
  white-space:nowrap;
  opacity:0.9;
  font-weight:bold;
}

/* ETA表示（90分枠用） */
.row .eta{
  display:inline-block;
  width:78px;
  margin-left:8px;
  font-size:15px;
  white-space:nowrap;
  opacity:0.9;
  font-weight:bold;
  text-align:left;
}

/* ★ 90分枠ハイライト */
.row.highlight{
  background:#d94c4c !important;
  color:#fff !important;
}

@media(max-width:900px){
  .columns{flex-direction:column;}
}

/* ===== 音量コントロール ===== */
.volume-box{
  text-align:center;
  margin-bottom:12px;
  font-size:14px;
}

.volume-box input[type="range"]{
  width:160px;
  vertical-align:middle;
}

/* ===== 機能説明エリア ===== */
.info-area{
  margin-top:28px;
  padding:14px 18px;
  background:#11182b;
  border-radius:8px;
  font-size:14px;
  line-height:1.6;
  opacity:0.95;
}

.info-area h3{
  margin:0 0 10px;
  font-size:16px;
  text-align:center;
}

.info-block{
  margin-bottom:10px;
}

.info-block strong{
  display:block;
  margin-bottom:2px;
  color:#9fd3ff;
}

/* 60分枠 ETA5~1分前ハイライト */
.task60.warning{
  background:#f4e38a !important;
  color:#000 !important;
}

/* 時刻入力の時計アイコンを白にする（Chrome / Edge） */
input[type="time"]::-webkit-calendar-picker-indicator {
  filter: invert(1);
  cursor: pointer;
}

</style>
</head>

<body>
<div class="container">
<h2>クレセントアイル:南征編</h2>

<!-- ★ 音量バー -->
<div class="volume-box">
  通知音量：
  <input id="volume" type="range" min="0" max="0.3" step="0.01">
  <button onclick="audio.currentTime=0; audio.play();">音テスト</button>
</div>

<div style="text-align:center;margin-bottom:12px;">
  <button onclick="clearAllTimers()" style="font-size:14px;padding:6px 14px;">
    全タイマークリア
  </button>
</div>

<div class="columns">
  <div class="task60-column" id="task60"></div>
  <div class="column90"><div id="task90"></div></div>
</div>

<div class="info-area" style="margin-top:28px;">
  <h3>v1.3.1-release (2025-12-19)</h3>
  <div class="info-block">
    <strong>追加機能</strong>
    <ul>
      <div>ポットタイマーに下記の機能を追加しました</div>
    </br>
      <li>両方の時刻が空欄の場合、[現在]ボタンを押すことでもう片方は30分前の時刻が自動で入力されます</li>
      <li>ポットの湧き時間(入力時刻の60分後)になった時、自動で1時間後の時刻に繰り上げられるようになりました</li>
    </ul>
  </div>
  <hr style="border-color:#355e6f;">
  <h3>v1.3-release (2025-12-19)</h3>
  <div class="info-block">
    <strong>追加機能</strong>
    <ul>
      <li>ポットタイマーが、次回時刻の5〜1分前に背景を黄色で表示するようになりました</li>
      <li>ポットタイマーが、5分前になると音を鳴らすようになりました</li>
      <li>通知音の音量調整とテストボタンを追加しました</li>
    </ul>
  </div>
  <hr style="border-color:#355e6f;">
  <div class="info-block">
    <strong>使用方法</strong>
    <p>時刻を自動入力もしくは手動入力することで、ポットは60分後、CEは90分後の時刻が表示されるようになります。</p>
    <p>ポットタイマーは次回時刻の5分前に自動で音が鳴ります（CEタイマーは音が鳴らないようになっています）。</p>
    <p>音の調整は上部の音量バーと音テストボタンから調整が可能です。</p>
    <p>わからない点・機能追加要望などがあれば <strong>前川店長 (discord: t2maekawa_ / <a href="https://x.com/t2maekawa_inkya" target="_blank">X(twitter)</a>) </strong> までご連絡ください。</p>
  </div>
</div>
</div>

<!-- ★ 通知音 -->
<audio id="beep" src="beep.mp3" preload="auto"></audio>

<script>
const STORAGE_KEY = 'crescent_ce_state';
const VOLUME_KEY  = 'crescent_ce_volume';

/* ===== 音量管理 ===== */
const audio = document.getElementById('beep');
const volume = document.getElementById('volume');

volume.value = localStorage.getItem(VOLUME_KEY) ?? 0.5;
audio.volume = volume.value;

volume.addEventListener('input',()=>{
  audio.volume = volume.value;
  localStorage.setItem(VOLUME_KEY, volume.value);
});

/* ★ 前回チェック時刻 */
let lastCheckTime = new Date();

/* ===== データ ===== */
const tasks60=[{label:"ポット: 北"},{label:"ポット: 南"}];
const tasks90=[
  {label:"鳥嫌い巨獣「ネオガルラ」",note:"KL1   ガルラ"},
  {label:"黒の連隊",note:"KL14 パンサー"},
  {label:"伝説の鮫「ニーム・ペタロドゥス」",note:"KL7   レッサーペタロドゥス"},
  {label:"呪いの商亀「コイントートス」",note:"KL7   ケートス"},
  {label:"セキュリティ・コマンドー",note:"KL8   ウラグナイト"},
  {label:"石造りの守護騎士たち",note:"KL4   マロリス"},
  {label:"二足の獅子「ランパントライオン」",note:"KL5   ファン"},
  {label:"復元された獅子像「リペアドライオン」",note:"KL20 ステータント"},
  {label:"昏き篝火「ヒンキーパンク」",note:"KL11 ハルピュイア"},
  {label:"神秘の偶像「ミシカルアイドル」",note:"KL13 ビブロス"},
  {label:"模造されしもの「水晶竜」",note:"KL19 クレイクロウ"},
  {label:"脳髄愛好家「マインドフレイア」",note:"KL15 モンク"},
  {label:"忍び寄る爪「デスクロー」",note:"KL16 ブラックガード"},
  {label:"怒れる人造人間「クレセント・バーサーカー」",note:"KL17 デーモンポーン"},
  {label:"封印大妖「クロイスターデーモン」",note:"KL20 インクステイン"}
];

const colors=[
'row-yellow','row-yellow','row-orange','row-orange','row-orange',
'row-purple','row-purple','row-purple','row-green','row-green','row-green',
'row-blue','row-blue','row-blue','row-cyan'
];

/* ===== 生成 ===== */
const c60=document.getElementById('task60');
tasks60.forEach((t,i)=>{
  c60.insertAdjacentHTML('beforeend',`
    <div class="task60" data-limit="60" data-id="60-${i}" data-beeped="0">
      <div class="label60">${t.label}</div>
      <input type="time">
      <div class="buttons">
        <button onclick="now(this)">現在</button>
        <button onclick="clr(this)">消去</button>
      </div>
      <div class="eta"></div>
    </div>
  `);
});

const c90=document.getElementById('task90');
tasks90.forEach((t,i)=>{
  c90.insertAdjacentHTML('beforeend',`
    <div class="row ${colors[i]}" data-limit="90" data-id="90-${i}">
      <span class="label">${t.label}</span>
      <span class="eta"></span>
      <input type="time">
      <button onclick="now(this)">現在時刻</button>
      <button onclick="clr(this)">クリア</button>
      <input class="note" value="${t.note}" readonly>
      <span class="checkbox-label">仕込み</span>
      <input type="checkbox">
    </div>
  `);
});

/* ===== LocalStorage ===== */
function saveState(){
  const data={};
  document.querySelectorAll('[data-id]').forEach(b=>{
    data[b.dataset.id]={
      time:b.querySelector('input[type="time"]')?.value || '',
      check:b.querySelector('input[type="checkbox"]')?.checked || false
    };
  });
  localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
}

function loadState(){
  const data=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
  document.querySelectorAll('[data-id]').forEach(b=>{
    const s=data[b.dataset.id];
    if(!s) return;
    if(s.time){
      b.querySelector('input[type="time"]').value=s.time;
      updateETA(b);
    }
    if(b.querySelector('input[type="checkbox"]')){
      b.querySelector('input[type="checkbox"]').checked=s.check;
    }
  });
}

/* ===== 共通処理 ===== */
function now(b){
  const box = b.closest('[data-limit]');
  const i   = box.querySelector('input[type="time"]');
  const n   = new Date();

  const hh = String(n.getHours()).padStart(2,'0');
  const mm = String(n.getMinutes()).padStart(2,'0');
  i.value = `${hh}:${mm}`;

  /* ★ 追加：60分枠・両方未入力ならもう片方に30分前を入れる */
  if(box.dataset.limit === "60"){
    const all60 = [...document.querySelectorAll('.task60 input[type="time"]')];
    const filled = all60.filter(t => t.value);

    if(filled.length === 1){
      const other = all60.find(t => t !== i);
      if(other){
        const d = new Date(n);
        d.setMinutes(d.getMinutes() - 30);
        other.value =
          `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        updateETA(other.closest('[data-limit]'));
      }
    }
  }

  updateETA(box);
  saveState();
}

function clr(b){
  const box=b.closest('[data-limit]');
  box.querySelector('input[type="time"]').value='';
  box.querySelector('.eta').textContent='';
  box.classList.remove('highlight');  // 既存赤ハイライトリセット
  box.classList.remove('warning');    // ★追加：黄色背景リセット
  if(box.dataset.limit=="60") box.dataset.beeped="0";
  saveState();
}

function updateETA(box){
  const i = box.querySelector('input[type="time"]');
  if(!i.value) return;
  const [h,m] = i.value.split(':').map(Number);
  const t = new Date();
  t.setHours(h,m,0,0);
  t.setMinutes(t.getMinutes()+Number(box.dataset.limit));
  box.querySelector('.eta').textContent = `⏰ ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;

  // ETA更新時に音フラグをリセット（60分枠のみ）
  if(box.dataset.limit=="60") box.dataset.beeped="0";
}

/* ★ ETA5分前通知（60分枠のみ） */
function check(){
  const now = new Date();
  document.querySelectorAll('[data-limit]').forEach(r=>{
    const i = r.querySelector('input[type="time"]');
    if(!i.value){
      r.classList.remove('highlight');
      return;
    }

    const [h,m] = i.value.split(':').map(Number);
    const start = new Date();
    start.setHours(h,m,0,0);
    if(start > now) start.setDate(start.getDate()-1);

    const diffNow = (now - start)/60000;
    const limit = Number(r.dataset.limit);

    if(limit===60){
      if(!i.value) { // 時間未入力ならリセット
        r.classList.remove('warning');
        r.classList.remove('highlight');
        return;
      }

      const minutesLeft = limit - diffNow;
      const minutesLeftCeil = Math.ceil(minutesLeft);

      // 5分〜1分前で黄色
      r.classList.toggle('warning', minutesLeftCeil <= 5 && minutesLeftCeil >= 1);

      // ETA到達で赤
      r.classList.toggle('highlight', Math.floor(diffNow) === limit);

      // 55分経過かつまだ鳴っていない場合
      if(Math.floor(diffNow) === 55 && r.dataset.beeped !== "1"){
        audio.currentTime = 0;
        audio.play();
        r.dataset.beeped = "1";
      }

      // ★ ETA到達で入力時刻を自動更新（60分枠のみ）
      if(Math.floor(diffNow) === limit){
        const next = new Date(start);
        next.setMinutes(next.getMinutes() + limit);

        i.value =
        `${String(next.getHours()).padStart(2,'0')}:${String(next.getMinutes()).padStart(2,'0')}`;

        updateETA(r);
        r.dataset.beeped = "0"; // 次周回用
        saveState();
      }
    }
  });
}

document.addEventListener('change',e=>{
  if(e.target.matches('input[type="time"],input[type="checkbox"]')){
    updateETA(e.target.closest('[data-limit]'));
    saveState();
  }
});

function clearAllTimers(){
  document.querySelectorAll('[data-limit]').forEach(box=>{
    const time=box.querySelector('input[type="time"]');
    const eta=box.querySelector('.eta');
    if(time) time.value='';
    if(eta) eta.textContent='';
    box.classList.remove('highlight');
    if(box.dataset.limit=="60") box.dataset.beeped="0";
  });
  saveState();
}

loadState();
setInterval(check,1000);
</script>
</body>
</html>
