<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>クレセントアイルCE管理</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+2:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  padding:20px;
  font-family:'M PLUS 2',sans-serif;
  background:#1a2238;
  color:#fff;
}
.container{max-width:1050px;margin:auto;}
h2{margin-bottom:12px; text-align:center;}
.columns{display:flex;gap:16px;align-items:flex-start;}

.task60-column{display:flex;flex-direction:column;gap:8px;}
.task60{
  background:#2a5f78;
  border-radius:6px;
  padding:6px;
  width:100px;
  color:#fff;
}
.task60-inner{
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
}
.task60-inner input[type="time"]{
  width:70px;
  height:24px;
  padding:2px 4px;
  margin-left:6px;
  font-size:12px;
  border:1px solid #355e6f;
  border-radius:4px;
  box-sizing:border-box;
}
.task60-inner .buttons{
  display:flex;
  gap:4px;
  justify-content:center;
}
.task60-inner button{
  width:42px;
  flex:none;
}
.task60 .label60{
  font-size:12px;
  font-weight:700;
  text-align:center;
  margin-bottom:4px;
}
.task60 .eta{
  font-size:16px;
  text-align:center;
  font-weight:bold;
}
.task60.highlight{
  background:#c63c3c;
  color:#fff;
}
.task60.warning{
  background:#f4e38a;
  color:#000;
}

.map-link{width:100px;}
.map-button{
  width:112%;
  padding:6px;
  font-size:12px;
  font-weight:700;
  background:#2a5f78;
  color:#fff;
  border:1px solid #355e6f;
  border-radius:6px;
  cursor:pointer;
}
.map-button:hover{background:#34718f;}

.column90{flex:1;}
.row{
  display:flex;
  align-items:center;
  margin-bottom:8px;
  padding:6px 8px;
  border-radius:4px;
}
.row-yellow{background:#f4e38a;color:#000;}
.row-orange{background:#f5c493;color:#000;}
.row-purple{background:#cbb4e7;color:#000;}
.row-green{background:#a9ddb4;color:#000;}
.row-blue{background:#a2c8e5;color:#000;}
.row-cyan{background:#a1e0e7;color:#000;}

.label{width:340px;font-weight:bold;}
input[type="time"]{
  background:#1e1e2e;
  color:#fff;
  border:1px solid #444;
  padding:2px 4px;
  width:72px;
  margin-right:6px;
}
input.note{
  background:#1e1e2e;
  color:#ccc;
  border:1px solid #444;
  padding:4px;
  width:180px;
}
button{
  background:#3a4b6e;
  color:#fff;
  border:1px solid #5a6b8e;
  cursor:pointer;
  margin-right:6px;
}
button:hover{background:#4b5c80;}

.checkbox-label{
  margin-left:8px;
  font-size:13px;
  white-space:nowrap;
}
.row .eta{
  display:inline-block;
  width:78px;
  margin-left:8px;
  font-size:15px;
  white-space:nowrap;
  font-weight:bold;
}
.row.highlight{
  background:#d94c4c;
  color:#fff;
}

@media(max-width:900px){
  .columns{flex-direction:column;}
}

.volume-box{
  text-align:center;
  margin-bottom:12px;
  font-size:14px;
}
.volume-box input[type="range"]{
  width:160px;
  vertical-align:middle;
}

.current-time{
  text-align:center;
  margin-bottom:16px;
  color:#9fd3ff;
}
.ct-label{
  font-size:16px;
  font-weight:bold;
}
.ct-time{
  font-size:26px;
  font-weight:bold;
}

input[type="time"]::-webkit-calendar-picker-indicator{
  filter:invert(1);
  cursor:pointer;
}

.info-area h1,
.info-area h2,
.info-area h3{
  text-align:center;
  color:#9fd3ff;
}

.info-area ul{
  padding-left:20px;
}

/* README 表示エリア */
#readme-container{
  max-width:1050px;          /* container と同じ */
  margin:24px auto 0;        /* 上に少し余白 */
  padding:16px 20px;
  background:#222b45;        /* body(#1a2238)より少し明るい */
  border-radius:8px;
  border:1px solid #2f3a5c;
  box-sizing:border-box;
}

#readme{
  font-size:14px;
  line-height:1.7;
  color:#e6ecff;
}

/* README 内の見出し */
#readme h1,
#readme h2,
#readme h3{
  margin-top:1.4em;
  margin-bottom:0.6em;
  border-bottom:1px solid #3a4b6e;
  padding-bottom:4px;
}

/* リスト */
#readme ul{
  padding-left:1.4em;
}
#readme li{
  margin:4px 0;
}

/* 強調 */
#readme strong{
  color:#ffffff;
}

/* コード */
#readme code{
  background:#1e1e2e;
  padding:2px 6px;
  border-radius:4px;
  font-size:13px;
}

/* 区切り線 */
#readme hr{
  border:none;
  border-top:1px solid #3a4b6e;
  margin:16px 0;
}

</style>
</head>

<body>
<div class="container">

<h2>クレセントアイル:南征編</h2>

<div class="volume-box">
通知音量：
<input id="volume" type="range" min="0" max="0.3" step="0.01">
<button onclick="audio.currentTime=0;audio.play();">音テスト</button>
</div>

<div style="text-align:center;margin-bottom:12px;">
<button onclick="clearAllTimers()" style="font-size:14px;padding:6px 14px;">
全タイマークリア
</button>
</div>

<div id="current-time" class="current-time">
<div class="ct-label">現在時刻</div>
<div class="ct-time">--:--:--</div>
</div>

<div class="columns">
<div class="task60-column" id="task60">
<div class="map-link" style="text-align:center;">
<a href="map.html" target="_blank" style="text-decoration:none;">
<button class="map-button">銅 / 銀箱<br>チェックマップ</button>
</a>
</div>
</div>

<div class="column90">
<div id="task90"></div>
</div>
</div>

</div>

<div class="info-area">
  <div id="readme"></div>
</div>

<audio id="beep" src="beep.mp3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
const STORAGE_KEY='crescent_ce_state';
const VOLUME_KEY='crescent_ce_volume';

const audio=document.getElementById('beep');
const volume=document.getElementById('volume');

volume.value=localStorage.getItem(VOLUME_KEY)??0.5;
audio.volume=volume.value;

volume.addEventListener('input',()=>{
  audio.volume=volume.value;
  localStorage.setItem(VOLUME_KEY,volume.value);
});

const tasks60=[{label:"ポット: 北"},{label:"ポット: 南"}];

const tasks90=[
{label:"鳥嫌い巨獣「ネオガルラ」",note:"KL1 ガルラ"},
{label:"黒の連隊",note:"KL14 パンサー"},
{label:"伝説の鮫「ニーム・ペタロドゥス」",note:"KL7 レッサーペタロドゥス"},
{label:"呪いの商亀「コイントートス」",note:"KL7 ケートス"},
{label:"セキュリティ・コマンドー",note:"KL8 ウラグナイト"},
{label:"石造りの守護騎士たち",note:"KL4 マロリス"},
{label:"二足の獅子「ランパントライオン」",note:"KL5 ファン"},
{label:"復元された獅子像「リペアドライオン」",note:"KL20 ステータント"},
{label:"昏き篝火「ヒンキーパンク」",note:"KL11 ハルピュイア"},
{label:"神秘の偶像「ミシカルアイドル」",note:"KL13 ビブロス"},
{label:"模造されしもの「水晶竜」",note:"KL19 クレイクロウ"},
{label:"脳髄愛好家「マインドフレイア」",note:"KL15 モンク"},
{label:"忍び寄る爪「デスクロー」",note:"KL16 ブラックガード"},
{label:"怒れる人造人間「クレセント・バーサーカー」",note:"KL17 デーモンポーン"},
{label:"封印大妖「クロイスターデーモン」",note:"KL20 インクステイン"}
];

const colors=[
'row-yellow','row-yellow','row-orange','row-orange','row-orange',
'row-purple','row-purple','row-purple',
'row-green','row-green','row-green',
'row-blue','row-blue','row-blue',
'row-cyan'
];

const c60=document.getElementById('task60');
tasks60.forEach((t,i)=>{
  c60.insertAdjacentHTML('beforeend',`
    <div class="task60" data-limit="60" data-id="60-${i}" data-beeped="0">
      <div class="label60">${t.label}</div>
      <div class="task60-inner">
        <input type="time">
        <div class="buttons">
          <button onclick="now(this)">現在</button>
          <button onclick="clr(this)">消去</button>
        </div>
      </div>
      <div class="eta"></div>
    </div>
  `);
});

const c90=document.getElementById('task90');
tasks90.forEach((t,i)=>{
  c90.insertAdjacentHTML('beforeend',`
    <div class="row ${colors[i]}" data-limit="90" data-id="90-${i}">
      <span class="label">${t.label}</span>
      <span class="eta"></span>
      <input type="time">
      <button onclick="now(this)">現在時刻</button>
      <button onclick="clr(this)">クリア</button>
      <input class="note" value="${t.note}" readonly>
      <span class="checkbox-label">仕込み</span>
      <input type="checkbox">
    </div>
  `);
});

function saveState(){
  const data={};
  document.querySelectorAll('[data-id]').forEach(b=>{
    data[b.dataset.id]={
      time:b.querySelector('input[type="time"]')?.value||'',
      check:b.querySelector('input[type="checkbox"]')?.checked||false
    };
  });
  localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
}

function loadState(){
  const data=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
  document.querySelectorAll('[data-id]').forEach(b=>{
    const s=data[b.dataset.id];
    if(!s) return;
    if(s.time){
      b.querySelector('input[type="time"]').value=s.time;
      updateETA(b);
    }
    const chk=b.querySelector('input[type="checkbox"]');
    if(chk) chk.checked=s.check;
  });
}

function now(btn){
  const box=btn.closest('[data-limit]');
  const input=box.querySelector('input[type="time"]');
  const n=new Date();
  const hh=String(n.getHours()).padStart(2,'0');
  const mm=String(n.getMinutes()).padStart(2,'0');
  input.value=`${hh}:${mm}`;

  if(box.dataset.limit==="60"){
    const all=[...document.querySelectorAll('.task60 input[type="time"]')];
    const filled=all.filter(t=>t.value);
    if(filled.length===1){
      const other=all.find(t=>t!==input);
      const d=new Date(n);
      d.setMinutes(d.getMinutes()-30);
      other.value=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      updateETA(other.closest('[data-limit]'));
    }
  }
  updateETA(box);
  saveState();
}

function clr(btn){
  const box=btn.closest('[data-limit]');
  box.querySelector('input[type="time"]').value='';
  box.querySelector('.eta').textContent='';
  box.classList.remove('highlight','warning');

  if(box.dataset.limit==="60"){
    box.dataset.beeped="0";
    delete box.dataset.etaTime;
  }

  saveState();
}

function updateETA(box){
  const i = box.querySelector('input[type="time"]');
  if(!i.value) return;

  const [h,m] = i.value.split(':').map(Number);
  const start = new Date();
  start.setHours(h,m,0,0);

  const eta = new Date(start);
  eta.setMinutes(eta.getMinutes() + Number(box.dataset.limit));

  const hh = String(eta.getHours()).padStart(2,'0');
  const mm = String(eta.getMinutes()).padStart(2,'0');

  if(box.dataset.limit === "60"){
    box.querySelector('.eta').innerHTML =
      `次: ${hh}:${mm}<br>あと -- 分後`;
    box.dataset.etaTime = eta.getTime(); // ★ ETAを保存
    box.dataset.beeped = "0";
  }else{
    box.querySelector('.eta').textContent =
      `次: ${hh}:${mm}`;
  }
}

function check(){
  const now=new Date();
  document.querySelectorAll('[data-limit]').forEach(r=>{
    const i=r.querySelector('input[type="time"]');
    // ===== 60分枠：残り時間表示（ETA参照）=====
    if(r.dataset.limit === "60" && r.dataset.etaTime){
      const nowTime = now.getTime();
      const diff = Math.max(0, r.dataset.etaTime - nowTime);

      const min = Math.ceil(diff / 60000); // 分のみ（切り上げ）

      const mm = String(min).padStart(2,'0');

      const etaDiv = r.querySelector('.eta');
      if(etaDiv){
        const lines = etaDiv.innerHTML.split('<br>');
        lines[1] = `あと ${mm} 分後`;
        etaDiv.innerHTML = lines.join('<br>');
      }
    }
    if(!i.value){
      r.classList.remove('highlight','warning');
      return;
    }
    const [h,m]=i.value.split(':').map(Number);
    const start=new Date();
    start.setHours(h,m,0,0);
    if(start>now) start.setDate(start.getDate()-1);
    const diff=(now-start)/60000;
    const limit=Number(r.dataset.limit);

    if(limit===60){
      const left=Math.ceil(limit-diff);
      r.classList.toggle('warning',left<=5&&left>=1);
      r.classList.toggle('highlight',Math.floor(diff)===limit);

      if(Math.floor(diff)===55 && r.dataset.beeped!=="1"){
        audio.currentTime=0;
        audio.play();
        r.dataset.beeped="1";
      }

      if(Math.floor(diff)===limit){
        const next=new Date(start);
        next.setMinutes(next.getMinutes()+limit);
        i.value=`${String(next.getHours()).padStart(2,'0')}:${String(next.getMinutes()).padStart(2,'0')}`;
        updateETA(r);
        r.dataset.beeped="0";
        saveState();
      }
    }
  });
}

document.addEventListener('change',e=>{
  if(e.target.matches('input[type="time"],input[type="checkbox"]')){
    updateETA(e.target.closest('[data-limit]'));
    saveState();
  }
});

function clearAllTimers(){
  document.querySelectorAll('[data-limit]').forEach(box=>{
    box.querySelector('input[type="time"]').value='';
    box.querySelector('.eta').textContent='';
    box.classList.remove('highlight','warning');

    if(box.dataset.limit==="60"){
      box.dataset.beeped="0";
      delete box.dataset.etaTime; // ★ ETA基準を完全破棄
    }
  });
  saveState();
}

loadState();
setInterval(check,1000);

const currentTimeEl=document.querySelector('.ct-time');
function updateCurrentTime(){
  const n=new Date();
  currentTimeEl.textContent=
    `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}:${String(n.getSeconds()).padStart(2,'0')}`;
}
updateCurrentTime();
setInterval(updateCurrentTime,1000);

fetch('README.md')
  .then(res => res.text())
  .then(md => {
    document.getElementById('readme').innerHTML = marked.parse(md);
  })
  .catch(() => {
    document.getElementById('readme').textContent =
      'README.md の読み込みに失敗しました';
  });

</script>

</body>
</html>
